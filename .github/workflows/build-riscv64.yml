name: Build RISC-V 64

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-riscv64:
    name: linux-riscv64
    runs-on: [self-hosted, linux, riscv64]
    timeout-minutes: 45
    if: >-
      github.repository != 'mistralai/mistral-vibe' &&
      (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Build vibe-acp
        run: bash scripts/build-riscv64.sh

      - name: Get package version
        id: version
        run: |
          source .venv-riscv64/bin/activate
          VERSION="$(python -c 'from vibe import __version__; print(__version__)')"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          deactivate

      - name: Upload binary artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: vibe-acp-linux-riscv64-${{ steps.version.outputs.version }}
          path: dist/vibe-acp

  create-release:
    name: Create fork release
    needs: build-riscv64
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
      - name: Check if release already exists
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.build-riscv64.outputs.version }}
        run: |
          TAG="v${VERSION}"
          if gh release view "$TAG" --repo "$GITHUB_REPOSITORY" &>/dev/null; then
            echo "Release $TAG already exists — skipping"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "No release for $TAG — will create"
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Download artifact
        if: steps.check.outputs.exists == 'false'
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          path: artifacts

      - name: Zip artifact
        if: steps.check.outputs.exists == 'false'
        env:
          VERSION: ${{ needs.build-riscv64.outputs.version }}
        run: |
          mkdir -p release-assets
          BINARY="$(find artifacts/ -name 'vibe-acp' -type f | head -1)"
          if [[ -z "$BINARY" ]]; then
            echo "::error::No vibe-acp binary found in artifacts/"
            exit 1
          fi

          ZIP_NAME="vibe-acp-linux-riscv64-${VERSION}.zip"
          chmod +x "$BINARY"
          zip -j "release-assets/${ZIP_NAME}" "$BINARY"
          echo "Created: release-assets/${ZIP_NAME}"

      - name: Fetch upstream release notes
        if: steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.check.outputs.tag }}
        run: |
          gh release view "$TAG" --repo mistralai/mistral-vibe --json body --jq '.body' \
            > /tmp/upstream-notes.md 2>/dev/null || true

      - name: Generate release notes
        if: steps.check.outputs.exists == 'false'
        env:
          VERSION: ${{ needs.build-riscv64.outputs.version }}
          TAG: ${{ steps.check.outputs.tag }}
        run: |
          ARTIFACT="$(ls release-assets/*.zip 2>/dev/null | head -1)"
          ARTIFACT_NAME="$(basename "$ARTIFACT")"

          {
            echo "RISC-V 64 build of Mistral Vibe — the open-source CLI coding assistant by Mistral AI."
            echo ""
            echo "## Download"
            echo ""
            echo "| Platform | Architecture | File |"
            echo "|----------|-------------|------|"
            echo "| Linux | riscv64 | \`${ARTIFACT_NAME}\` |"
            echo ""
            echo "## Installation"
            echo ""
            echo '```bash'
            echo "unzip ${ARTIFACT_NAME}"
            echo "chmod +x vibe-acp"
            echo "sudo mv vibe-acp /usr/local/bin/"
            echo "vibe-acp --version"
            echo '```'
            echo ""
            echo "## Upstream Release"
            echo ""
            echo "This build is based on [${TAG}](https://github.com/mistralai/mistral-vibe/releases/tag/${TAG}) from [mistralai/mistral-vibe](https://github.com/mistralai/mistral-vibe)."
            echo ""
            echo "For other platforms (x86_64, aarch64, macOS, Windows), see the [upstream release](https://github.com/mistralai/mistral-vibe/releases/tag/${TAG})."
          } > /tmp/release-body.md

          if [[ -s /tmp/upstream-notes.md ]]; then
            {
              echo ""
              echo "---"
              echo ""
              echo "<details>"
              echo "<summary>Upstream release notes</summary>"
              echo ""
              cat /tmp/upstream-notes.md
              echo ""
              echo "</details>"
            } >> /tmp/release-body.md
          fi

      - name: Create release
        if: steps.check.outputs.exists == 'false'
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: ${{ steps.check.outputs.tag }}
          target_commitish: main
          name: "${{ steps.check.outputs.tag }} (RISC-V 64)"
          body_path: /tmp/release-body.md
          files: release-assets/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
