name: Build Wheels

on:
  push:
    branches: [main, v*]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-wheels:
    name: Build wheel (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Install uv
        uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86 # v5
        with:
          version: "latest"

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Build wheel and sdist
        run: uv build

      - name: List built artifacts
        run: ls -la dist/

      - name: Upload wheel artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: wheel-py${{ matrix.python-version }}
          path: dist/*.whl
          retention-days: 30

      - name: Upload sdist artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: sdist
          path: dist/*.tar.gz
          retention-days: 30

  verify-wheels:
    name: Verify wheel (Python ${{ matrix.python-version }})
    needs: build-wheels
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download wheel
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4
        with:
          name: wheel-py${{ matrix.python-version }}
          path: dist/

      - name: Install wheel
        run: pip install dist/*.whl

      - name: Verify CLI commands
        run: |
          vibe --version
          vibe --help
          vibe-acp --version
          vibe-acp --help
