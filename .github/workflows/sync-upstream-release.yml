name: Sync Upstream Release

on:
  schedule:
    - cron: "0 6 * * *" # Daily at 06:00 UTC
  workflow_dispatch:
    inputs:
      force:
        description: "Release even if versions match (retry failed builds)"
        required: false
        type: boolean
        default: false
      upstream_tag:
        description: "Sync a specific upstream tag instead of latest"
        required: false
        type: string
        default: ""

concurrency:
  group: sync-upstream-release
  cancel-in-progress: false

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Check if upstream has a newer release than the fork
  # ---------------------------------------------------------------------------
  check-upstream:
    name: Check for new upstream release
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      new_release: ${{ steps.compare.outputs.new_release }}
      upstream_tag: ${{ steps.compare.outputs.upstream_tag }}
    steps:
      - name: Get upstream latest release
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM_TAG_INPUT: ${{ inputs.upstream_tag }}
        run: |
          if [[ -n "$UPSTREAM_TAG_INPUT" ]]; then
            TAG="$UPSTREAM_TAG_INPUT"
          else
            TAG="$(gh release view --repo mistralai/mistral-vibe --json tagName --jq '.tagName')"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Upstream latest: $TAG"

      - name: Get fork latest release
        id: fork
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="$(gh release view --repo "${{ github.repository }}" --json tagName --jq '.tagName' 2>/dev/null || echo '')"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Fork latest: ${TAG:-<none>}"

      - name: Compare versions
        id: compare
        env:
          UPSTREAM: ${{ steps.upstream.outputs.tag }}
          FORK: ${{ steps.fork.outputs.tag }}
          FORCE: ${{ inputs.force }}
        run: |
          echo "Upstream tag: $UPSTREAM"
          echo "Fork tag:     ${FORK:-<none>}"
          echo "Force:        ${FORCE:-false}"

          if [[ "$FORCE" == "true" ]] || [[ "$UPSTREAM" != "$FORK" ]]; then
            echo "new_release=true" >> "$GITHUB_OUTPUT"
            echo "New release detected (or forced)"
          else
            echo "new_release=false" >> "$GITHUB_OUTPUT"
            echo "No new release — fork is up to date"
          fi

          echo "upstream_tag=$UPSTREAM" >> "$GITHUB_OUTPUT"

  # ---------------------------------------------------------------------------
  # Job 2: Merge upstream tag into the fork's main branch
  # ---------------------------------------------------------------------------
  sync-fork:
    name: Sync fork with upstream
    needs: check-upstream
    if: needs.check-upstream.outputs.new_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout fork (full history for merge)
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge upstream tag
        env:
          UPSTREAM_TAG: ${{ needs.check-upstream.outputs.upstream_tag }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git remote add upstream https://github.com/mistralai/mistral-vibe.git
          git fetch upstream --tags --force

          echo "Merging upstream tag: $UPSTREAM_TAG"
          if ! git merge "$UPSTREAM_TAG" --no-edit; then
            echo "::error::Merge conflict detected. Conflicting files:"
            git diff --name-only --diff-filter=U
            echo ""
            echo "Manual resolution required:"
            echo "  git remote add upstream https://github.com/mistralai/mistral-vibe.git"
            echo "  git fetch upstream --tags"
            echo "  git merge $UPSTREAM_TAG"
            echo "  # resolve conflicts"
            echo "  git push origin main"
            exit 1
          fi

          echo "Merge successful — pushing to fork"
          git push origin main

      # GITHUB_TOKEN pushes don't trigger other workflows (anti-recursion rule),
      # so explicitly dispatch build-riscv64.yml via workflow_dispatch (which IS
      # allowed to trigger new runs even with GITHUB_TOKEN).
      - name: Trigger riscv64 build workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Dispatching build-riscv64 workflow..."
          gh workflow run build-riscv64.yml --repo "$GITHUB_REPOSITORY" --ref main
          echo "Build workflow dispatched"
